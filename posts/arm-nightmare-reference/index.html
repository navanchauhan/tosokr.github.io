<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Azure Resource Manager templates - lesson learned | Aleksandar Stefanov</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Azure Resource Manager templates - lesson learned" /><meta name="author" content="Aleksandar Stefanov" /><meta property="og:locale" content="en_US" /><meta name="description" content="How to add Web App outbound IP addresses into SQL Server firewall using Azure Resource Manager template" /><meta property="og:description" content="How to add Web App outbound IP addresses into SQL Server firewall using Azure Resource Manager template" /><link rel="canonical" href="https://tosokr.github.io/posts/arm-nightmare-reference/" /><meta property="og:url" content="https://tosokr.github.io/posts/arm-nightmare-reference/" /><meta property="og:site_name" content="Aleksandar Stefanov" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-13T13:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure Resource Manager templates - lesson learned" /><meta name="twitter:site" content="@tosokr" /><meta name="twitter:creator" content="@Aleksandar Stefanov" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Aleksandar Stefanov"},"description":"How to add Web App outbound IP addresses into SQL Server firewall using Azure Resource Manager template","@type":"BlogPosting","headline":"Azure Resource Manager templates - lesson learned","dateModified":"2020-04-13T13:00:00+02:00","datePublished":"2020-04-13T13:00:00+02:00","url":"https://tosokr.github.io/posts/arm-nightmare-reference/","mainEntityOfPage":{"@type":"WebPage","@id":"https://tosokr.github.io/posts/arm-nightmare-reference/"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous" async></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script><meta name="google-site-verification" content="KxW5HPA1atn0Rzb8EJxLtEDqib8_4WkXyUImvsv-QjY" /><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/profile/toso.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">Aleksandar Stefanov</a></div><div id="site-subtitle" class="font-italic">#learningbydoing</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex justify-content-around mt-4"> <a href="https://github.com/tosokr" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/tosokr" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['tosokr','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"> <!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Azure Resource Manager templates - lesson learned</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <a href="javascript:;">Cancel</a></div></div><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"> <!-- Define the liquid date formats. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Azure Resource Manager templates - lesson learned</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago" data-toggle="tooltip" title="Mon, Apr 13, 2020, 1:00 PM +0200"> Apr 13, 2020 <i class="unloaded">2020-04-13T13:00:00+02:00</i> </span> on <a href='/categories/arm-templates/'>ARM Templates</a></div></div><div class="post-content"><p>Last week I worked on an ARM template for a deployment that, among other resources, included Web Apps and SQL databases. One of the tasks was to allow the connection from the possible outbound IP addresses of the Web App into the SQL server. And there, my problem started, because I’m not very proficient in creating advanced ARM templates. In the paragraphs below, I will give a brief overview of the ARM templates, what was my problem, and how did I solve it.</p><h4 id="azure-resource-manager-templates">Azure Resource Manager templates</h4><blockquote><p>“The Azure Resource Manager (ARM) template is a JavaScript Object Notation (JSON) file that defines the infrastructure and configuration for your project. The template uses declarative syntax, which lets you state what you intend to deploy without having to write the sequence of programming commands to create it. In the template, you specify the resources to deploy and the properties for those resources.” – <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview">docs.microsoft.com</a></p></blockquote><p>The most significant advantage of ARM templates over scripts is that they are by design idempotent, meaning you will get the same result whenever you deploy the template, something that you want when you use release pipelines to deploy your solution. You can also create the deployment scripts (CLI and Powershell) in such a way that they are idempotent, but that usually involves a considerable overhead.</p><p>The ARM template consists from the following sections:</p><ul><li>Parameters – generalize the template by providing values during the deployment.</li><li>Variables - reusable values in the template.</li><li>User-defined functions - customized functions to simplify the template.</li><li>Resources - resources to deploy.</li><li>Outputs - return values from the deployed resources.</li></ul><h4 id="the-deployment">The deployment</h4><p>In the json snippets below, I’m showing the relevant parts from the deployment template. You can find the full templates in my Github repository <a href="https://github.com/tosokr/Azure/tree/master/arm/reference">here.</a></p><p>The ARM template takes two parameters: authorName and location. For simplicity, I added default values for the two.</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"authorName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tosokr"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name to use for generating the resource names relevant for this template"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[resourceGroup().location]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Location where to create the resources"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>In the variables section, I’m generating a unique names for my resources, because Web App and SQL server need to have globally unique names:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"appServicePlanName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(parameters('authorName'),uniqueString(resourceGroup().id),'-asp')]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"webAppName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(parameters('authorName'),uniqueString(resourceGroup().id),'-as')]"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sqlServerName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(parameters('authorName'),uniqueString(resourceGroup().id),'-dbs')]"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>With the tamplate I’m deploying three resources – App Service Plan, Web App and SQL Server:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Create the App Service Plan"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Web/serverfarms"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-02-01"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('appServicePlanName')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('location')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sku"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"S1"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Create the Web App"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Web/sites"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-01"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('webAppName')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('location')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"dependsOn"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"hostNameSslStates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(variables('webAppName'), '.azurewebsites.net')]"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"sslState"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Disabled"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"hostType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Standard"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(variables('webAppName'),'.scm.azurewebsites.net')]"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"sslState"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Disabled"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"hostType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Repository"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"serverFarmId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"httpsOnly"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Create the logical SQL Server"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Sql/servers"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-06-01-preview"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('sqlServerName')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('location')]"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v12.0"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"administratorLogin"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('authorName')]"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"administratorLoginPassword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat('P',uniqueString(variables('sqlServerName'),'!'))]"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"12.0"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"publicNetworkAccess"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Enabled"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></table></code></div></div><h4 id="the-challenge">The challenge</h4><p>The possible outbound IP addresses for a Web App is a list of IP addresses, so we need to create some loop to go through the list and add those IP addresses into the SQL firewall. In ARM templates, this is possible using the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/copy-resources">copy element</a>. To get the object of the WebApp, we need to use the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions-resource#reference">reference function</a>. But the reference function has a limition – “you can’t use the reference function to set the value of the count property in a copy loop”. Just “great”!!!</p><p>After spending some time trying different solutions, the only possibility was to use linked templates.</p><h4 id="linked-templates">Linked templates</h4><p>To overcome the limitation of the reference function, we will create a new linked template, send the list of IP addresses as parameters to that template and add those IP addresses into the firewall using the linked template. First, we need to add several things into our main template.</p><p>Because of the way the linked templates works, you need to store them on a public location from where the Azure Resource Manager can access them. The Azure Storage Account is one of the options for saving the templates, either as publicly accessible blobs or private blobs available through the use of SAS tokens. For the production deployments, I strongly recommended you to use SAS tokens.</p><p>In the main template, we will create a new variable which at runtime will have a value of the full URL of the linked template.</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nl">"addToSqlFirewallTemplateUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[replace(deployment().properties.templateLink.uri, '/master.template.json', '/addtosqlfirewall.template.json')]"</span><span class="w">
</span></pre></table></code></div></div><p>Also in the main template, under resources, we are adding a definition for a new deployment that is using the linked template:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"In separate template (because of the reference nightmare!!!) configure the SQL firewall rules"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2017-05-10"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"webAppIPsSQLFirewall"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Resources/deployments"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Incremental"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"templateLink"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('addToSqlFirewallTemplateUrl')]"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"contentVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0.0"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"webAppOutboundIpAddresses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[split(reference(concat('Microsoft.Web/sites/',variables('webAppName'))).possibleOutboundIpAddresses,',')]"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"sqlServerName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[variables('sqlServerName')]"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"dependsOn"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"[resourceId('Microsoft.Web/sites', variables('webAppName'))]"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>As a parameter, we are sending the array of the possible outbound IP addresses of the WebApp and SQL Server name to the linked template.</p><p>The linked template, named addtosqlfirewall.template.json, looks like this:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"contentVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"webAppOutboundIpAddresses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Array of possible Outbound IP addresses for the Web Application"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"sqlServerName"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of the logical SQL Server"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"resources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"comments"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Add the Outbound IP Addresses from the Web App"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Sql/servers/firewallRules"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-05-01-preview"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[concat(parameters('sqlServerName'), '/Allow WebApp Outbound IP ',copyIndex('webAppOutboundIPAddressesCopy'))]"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"startIpAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('webAppOutboundIpAddresses')[copyIndex('webAppOutboundIPAddressesCopy')]]"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"endIpAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('webAppOutboundIpAddresses')[copyIndex('webAppOutboundIPAddressesCopy')]]"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"copy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"webAppOutboundIPAddressesCopy"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[length(parameters('webAppOutboundIpAddresses'))]"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h4 id="upload-the-templates-to-an-azure-storage-account">Upload the templates to an Azure Storage Account</h4><p>We will create a storage account and a container with publicly accessible blobs and upload the two templates to the container. The random string is needed because storage accounts are using globally unique names.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">resourceGroup</span><span class="o">=</span>&lt;YOUR RESOURCE GROUP HERE&gt;
<span class="nv">randomString</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /dev/urandom | <span class="nb">tr</span> <span class="nt">-dc</span> <span class="s1">'a-z'</span> | <span class="nb">fold</span> <span class="nt">-w</span> 8 | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="si">)</span>
<span class="nv">blobUrl</span><span class="o">=</span><span class="si">$(</span>az storage account create <span class="nt">-g</span> <span class="nv">$resourceGroup</span> <span class="se">\</span>
<span class="nt">-n</span> tosokr<span class="nv">$randomString</span> <span class="nt">--query</span> primaryEndpoints.blob <span class="nt">-o</span> tsv<span class="si">)</span>
az storage container create <span class="nt">--account-name</span> tosokr<span class="nv">$randomString</span> <span class="se">\</span>
<span class="nt">--name</span> templates <span class="nt">--public-access</span> blob
az storage copy <span class="nt">-s</span> <span class="s2">"*"</span> <span class="nt">-d</span> <span class="nv">$blobUrl</span><span class="s2">"templates"</span>
</pre></table></code></div></div><h4 id="run-the-deployment">Run the deployment</h4><p>We will use Azure CLI to deploy the templates:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>az group deployment create <span class="nt">--name</span> myDeployment <span class="se">\</span>
<span class="nt">--resource-group</span> <span class="nv">$resourceGroup</span> <span class="nt">--template-uri</span> <span class="nv">$blobUrl</span><span class="s2">"templates/master.template.json"</span>
</pre></table></code></div></div><p>Lets verify that the SQL firewall includes the outbound IP addresses from the web app:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">sqlServerName</span><span class="o">=</span><span class="si">$(</span>az sql server list <span class="se">\</span>
<span class="nt">--resource-group</span> <span class="nv">$resourceGroup</span> <span class="nt">--query</span> <span class="o">[]</span>.name <span class="se">\</span>
<span class="nt">--o</span> tsv | <span class="nb">grep </span>tosokr<span class="si">)</span>
az sql server firewall-rule list <span class="se">\</span>
<span class="nt">-g</span> <span class="nv">$resourceGroup</span> <span class="nt">--server</span> <span class="nv">$sqlServerName</span> <span class="se">\</span>
<span class="nt">--query</span> <span class="s1">'[].{RuleName:name,IPaddress:startIpAddress}'</span> <span class="se">\</span>
<span class="nt">-o</span> table
</pre></table></code></div></div><p>In my case, the output was:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>RuleName                    IPaddress
<span class="nt">--------------------------</span>  <span class="nt">---------------</span>
Allow WebApp Outbound IP 0  13.69.68.2
Allow WebApp Outbound IP 1  23.97.146.237
Allow WebApp Outbound IP 2  137.117.153.170
Allow WebApp Outbound IP 3  104.40.201.109
Allow WebApp Outbound IP 4  104.40.205.110
Allow WebApp Outbound IP 5  104.40.200.176
Allow WebApp Outbound IP 6  104.40.204.252
Allow WebApp Outbound IP 7  104.40.205.29
</pre></table></code></div></div><p>Grab a beer! Now you know how to use the reference function in a loop.</p></div><div class="post-tail text-muted"><div class="mb-4"> <a href="/tags/arm/" class="post-tag no-text-decoration" >ARM</a></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 topbar-down"><div class="access"><div id="access-lastmod" class="post mb-4"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/migrate-virtual-machine-into-availability-zone/">Migrate virtual machine into availability zone</a></li><li><a href="/posts/azure-wan/">Managed and secured hub-spoke architecture using Azure WAN and Firewall Manager</a></li><li><a href="/posts/aks-virtualnode-appgateway/">Quickly and efficiently scale containerized applications using Azure Kubernetes Service, Container Instances, and Application Gateway</a></li><li><a href="/posts/curl-appgateway-error/">SSL certificate error when accessing Application Gateway listener using curl</a></li><li><a href="/posts/appconfig-secrets-from-net-console-application/">How to use Key Vault references in App Configuration from .NET Framework Console application</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/certificates/">Certificates</a> <a class="post-tag" href="/tags/application-gateway/">Application Gateway</a> <a class="post-tag" href="/tags/apimpolicy/">APIMPolicy</a> <a class="post-tag" href="/tags/wan/">WAN</a> <a class="post-tag" href="/tags/vms/">VMs</a> <a class="post-tag" href="/tags/keyvault/">KeyVault</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/firewall-manager/">Firewall Manager</a> <a class="post-tag" href="/tags/bash/">Bash</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/azure-wan/" class="btn btn-outline-primary"><p>Managed and secured hub-spoke architecture using Azure WAN and Firewall Manager</p></a> <a href="javascript:;" class="btn btn-outline-primary disabled"><p>-</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const observer = lozad(); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="copyright"><p class="mb-0"> © 2020<a href="https://www.linkedin.com/in/aleksandarstefanov" class="ml-1">Aleksandar Stefanov</a>. <br>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener noreferrer">Jekyll</a> with theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a>.</p></div><div class="license"><p class="mb-0"> The blog posts on this site are licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/certificates/">Certificates</a> <a class="post-tag" href="/tags/application-gateway/">Application Gateway</a> <a class="post-tag" href="/tags/apimpolicy/">APIMPolicy</a> <a class="post-tag" href="/tags/wan/">WAN</a> <a class="post-tag" href="/tags/vms/">VMs</a> <a class="post-tag" href="/tags/keyvault/">KeyVault</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/firewall-manager/">Firewall Manager</a> <a class="post-tag" href="/tags/bash/">Bash</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-158589035-1', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://tosokr.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
