<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Migrate virtual machine into availability zone | Aleksandar Stefanov</title><meta name="generator" content="Jekyll v4.0.0" /><meta property="og:title" content="Migrate virtual machine into availability zone" /><meta name="author" content="Aleksandar Stefanov" /><meta property="og:locale" content="en_US" /><meta name="description" content="How to migrate an AzureVM into availability zone with powershell" /><meta property="og:description" content="How to migrate an AzureVM into availability zone with powershell" /><link rel="canonical" href="https://tosokr.github.io/posts/migrate-virtual-machine-into-availability-zone/" /><meta property="og:url" content="https://tosokr.github.io/posts/migrate-virtual-machine-into-availability-zone/" /><meta property="og:site_name" content="Aleksandar Stefanov" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-02-13T21:15:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Migrate virtual machine into availability zone" /><meta name="twitter:site" content="@tosokr" /><meta name="twitter:creator" content="@Aleksandar Stefanov" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://tosokr.github.io/posts/migrate-virtual-machine-into-availability-zone/"},"author":{"@type":"Person","name":"Aleksandar Stefanov"},"description":"How to migrate an AzureVM into availability zone with powershell","@type":"BlogPosting","url":"https://tosokr.github.io/posts/migrate-virtual-machine-into-availability-zone/","headline":"Migrate virtual machine into availability zone","dateModified":"2020-02-28T10:25:38+01:00","datePublished":"2020-02-13T21:15:00+01:00","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous" async></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script><meta name="google-site-verification" content="KxW5HPA1atn0Rzb8EJxLtEDqib8_4WkXyUImvsv-QjY" /><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/profile/tosokr.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">Aleksandar Stefanov</a></div><div id="site-subtitle" class="font-italic">My Azure repository</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex justify-content-around mt-4"> <a href="https://github.com/tosokr" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/tosokr" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['tosokr','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"> <!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Migrate virtual machine into availability zone</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <a href="javascript:;">Cancel</a></div></div><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"> <!-- Define the liquid date formats. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Migrate virtual machine into availability zone</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago" data-toggle="tooltip" title="Thu, Feb 13, 2020, 9:15 PM +0100"> Feb 13, 2020 <i class="unloaded">2020-02-13T21:15:00+01:00</i> </span> on <a href='/categories/virtual-machines/'>Virtual Machines</a></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" title="Fri, Feb 28, 2020, 10:25 AM +0100"> Feb 28, 2020 <i class="unloaded">2020-02-28T10:25:38+01:00</i> </span></div></div><div class="post-content"><p>Availability Zones is a high-availability offering that protects you from datacenter failures. Think of them as separate datacenter inside one Azure location. For example, West Europe is one location (Amsterdam, Netherlands), but inside that location, there are several datacenters. In your subscription, you can see Availability Zones labeled as 1, 2, and 3. Those numbers are just logical representations of the physical datacenters, meaning that, for example, Availability Zone 1 in West Europe for my subscription can point to different physical datacenter compared to the Availability Zone 1 in West Europe for your subscription.</p><p>When you create a VM, you have the following options for availability: <img class="lozad" src=/assets/img/commons/loading.png data-src="/assets/img/posts/vm/VMAvailabilityOptions.png" alt="Desktop View" /> Note that by default <em>No infrastructure redundancy required</em> is selected. If you create the VM with this option after that is not possible to move it to an Availability Set or an Availability Zone.</p><p>When may you need this? Imagine, for example, you install SQL Server inside a VM, configure everything, and after that, you choose to leverage some of the high availability options for SQL server, such as database mirroring or AlwaysOn availability groups. In such a scenario, it is a best practice to store those VMs into different Availability Zone (SLA of 99.99%) or in the same Availability Set (SLA of 99.95%).</p><p>The script workflow:</p><ol><li>Stop the VM</li><li>Create a snapshot of OS and data disks. From the snapshots create a managed disk in a chosen zone</li><li>Remove the VM</li><li>If there is a public Basic IP address on the NIC, remove it (this is because Basic Public IP addresses are not zone aware). If this is the case for you, after executing the script manually, add a Standard Public IP address to the NIC.</li><li>Create a new VM</li><li>(If you need it) Create an SQL VM object (this install the SQL IaaS agent into the VM)</li></ol><p>After you verify that everything is working, delete the old disks and the snapshots. Otherwise, you will end up paying to Microsoft for the provisioned space (if you are using SSD disks, this can be a significant sum of money).</p><div class="language-powershell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="err">﻿</span><span class="c"># Set variables</span><span class="w">
</span><span class="nv">$subscriptionId</span><span class="o">=</span><span class="s2">""</span><span class="w"> </span><span class="c">#Set to your subscription id where the VM is created</span><span class="w">
</span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="c">#Resouce group of the VM</span><span class="w">
</span><span class="nv">$vmName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="c">#VM Name</span><span class="w">
</span><span class="nv">$location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"westeurope"</span><span class="w"> </span><span class="c">#VM Location</span><span class="w">
</span><span class="nv">$zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2"</span><span class="w"> </span><span class="c">#1 2 or 3</span><span class="w">

</span><span class="c">#Login to the Azure</span><span class="w">
</span><span class="nf">Login-AzAccount</span><span class="w">

</span><span class="c">#Set the subscription</span><span class="w">
</span><span class="nf">Set-AzContext</span><span class="w"> </span><span class="nt">-Subscription</span><span class="w"> </span><span class="nv">$subscriptionId</span><span class="w">

</span><span class="c"># Get the details of the VM to be moved to the Availability Set</span><span class="w">
</span><span class="nv">$originalVM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Get-AzVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w">

</span><span class="c"># Stop the VM to take snapshot</span><span class="w">
</span><span class="nf">Stop-AzVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> 

</span><span class="c"># Create a SnapShot of the OS disk and then, create an Azure Disk with Zone information</span><span class="w">
</span><span class="nv">$snapshotOSConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-AzSnapshotConfig</span><span class="w"> </span><span class="nt">-SourceUri</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">OsDisk</span><span class="o">.</span><span class="nf">ManagedDisk</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nt">-SkuName</span><span class="w"> </span><span class="nx">Standard_ZRS</span><span class="w">
</span><span class="nv">$OSSnapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzSnapshot</span><span class="w"> </span><span class="nt">-Snapshot</span><span class="w"> </span><span class="nv">$snapshotOSConfig</span><span class="w"> </span><span class="nt">-SnapshotName</span><span class="w"> </span><span class="p">(</span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">OsDisk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"-snapshot"</span><span class="p">)</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> 
</span><span class="nv">$diskSkuOS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">Get-AzDisk</span><span class="w"> </span><span class="nt">-DiskName</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">OsDisk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">ResourceGroupName</span><span class="p">)</span><span class="o">.</span><span class="nf">Sku</span><span class="o">.</span><span class="nf">Name</span><span class="w">

</span><span class="nv">$diskConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzDiskConfig</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$OSSnapshot</span><span class="o">.</span><span class="nf">Location</span><span class="w"> </span><span class="nt">-SourceResourceId</span><span class="w"> </span><span class="nv">$OSSnapshot</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">Copy</span><span class="w"> </span><span class="nt">-SkuName</span><span class="w">  </span><span class="nv">$diskSkuOS</span><span class="w"> </span><span class="nt">-Zone</span><span class="w"> </span><span class="nv">$zone</span><span class="w"> 
</span><span class="nv">$OSdisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzDisk</span><span class="w"> </span><span class="nt">-Disk</span><span class="w"> </span><span class="nv">$diskConfig</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-DiskName</span><span class="w"> </span><span class="p">(</span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">OsDisk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"zone"</span><span class="p">)</span><span class="w">


</span><span class="c"># Create a Snapshot from the Data Disks and the Azure Disks with Zone information</span><span class="w">
</span><span class="nx">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$disk</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">DataDisks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 

   </span><span class="nv">$snapshotDataConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-AzSnapshotConfig</span><span class="w"> </span><span class="nt">-SourceUri</span><span class="w"> </span><span class="nv">$disk</span><span class="o">.</span><span class="nf">ManagedDisk</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">copy</span><span class="w"> </span><span class="nt">-SkuName</span><span class="w"> </span><span class="nx">Standard_ZRS</span><span class="w">
   </span><span class="nv">$DataSnapshot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzSnapshot</span><span class="w"> </span><span class="nt">-Snapshot</span><span class="w"> </span><span class="nv">$snapshotDataConfig</span><span class="w"> </span><span class="nt">-SnapshotName</span><span class="w"> </span><span class="p">(</span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'-snapshot'</span><span class="p">)</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w">

   </span><span class="nv">$diskSkuData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nf">Get-AzDisk</span><span class="w"> </span><span class="nt">-DiskName</span><span class="w"> </span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">ResourceGroupName</span><span class="p">)</span><span class="o">.</span><span class="nf">Sku</span><span class="o">.</span><span class="nf">Name</span><span class="w">
   </span><span class="nv">$datadiskConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzDiskConfig</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$DataSnapshot</span><span class="o">.</span><span class="nf">Location</span><span class="w"> </span><span class="nt">-SourceResourceId</span><span class="w"> </span><span class="nv">$DataSnapshot</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">Copy</span><span class="w"> </span><span class="nt">-SkuName</span><span class="w"> </span><span class="nv">$diskSkuData</span><span class="w"> </span><span class="nt">-Zone</span><span class="w"> </span><span class="nv">$zone</span><span class="w">
   </span><span class="nv">$datadisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">New-AzDisk</span><span class="w"> </span><span class="nt">-Disk</span><span class="w"> </span><span class="nv">$datadiskConfig</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-DiskName</span><span class="w"> </span><span class="p">(</span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"zone"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Remove the original VM</span><span class="w">
</span><span class="nf">Remove-AzVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$vmName</span><span class="w">  </span><span class="nt">-Force</span><span class="w">

</span><span class="c"># Create the basic configuration for the replacement VM</span><span class="w">
</span><span class="nv">$newVM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-AzVMConfig</span><span class="w"> </span><span class="nt">-VMName</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-VMSize</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">HardwareProfile</span><span class="o">.</span><span class="nf">VmSize</span><span class="w"> </span><span class="nt">-Zone</span><span class="w"> </span><span class="nv">$zone</span><span class="w">

</span><span class="c"># Add the pre-existed OS disk </span><span class="w">
</span><span class="nx">Set-AzVMOSDisk</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nv">$newVM</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">Attach</span><span class="w"> </span><span class="nt">-ManagedDiskId</span><span class="w"> </span><span class="nv">$OSdisk</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$OSdisk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-Windows</span><span class="w">

</span><span class="c"># Add the pre-existed data disks</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$disk</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">StorageProfile</span><span class="o">.</span><span class="nf">DataDisks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
    </span><span class="nv">$datadisk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Get-AzDisk</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-DiskName</span><span class="w"> </span><span class="p">(</span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"zone"</span><span class="p">)</span><span class="w">
    </span><span class="nf">Add-AzVMDataDisk</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nv">$newVM</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$datadisk</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-ManagedDiskId</span><span class="w"> </span><span class="nv">$datadisk</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Caching</span><span class="w"> </span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Caching</span><span class="w"> </span><span class="nt">-Lun</span><span class="w"> </span><span class="nv">$disk</span><span class="o">.</span><span class="nf">Lun</span><span class="w"> </span><span class="nt">-DiskSizeInGB</span><span class="w"> </span><span class="nv">$disk</span><span class="o">.</span><span class="nf">DiskSizeGB</span><span class="w"> </span><span class="nt">-CreateOption</span><span class="w"> </span><span class="nx">Attach</span><span class="w"> 
</span><span class="p">}</span><span class="w">

</span><span class="c"># Add NIC(s) and keep the same NIC as primary</span><span class="w">
</span><span class="c"># If there is a Public IP from the Basic SKU remove it because it doesn't supports zones</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$nic</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">NetworkProfile</span><span class="o">.</span><span class="nf">NetworkInterfaces</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
   </span><span class="nv">$netInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Get-AzNetworkInterface</span><span class="w"> </span><span class="nt">-ResourceId</span><span class="w"> </span><span class="nv">$nic</span><span class="o">.</span><span class="nf">Id</span><span class="w"> 
   </span><span class="nv">$publicIPId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$netInterface</span><span class="o">.</span><span class="nf">IpConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">PublicIpAddress</span><span class="o">.</span><span class="nf">Id</span><span class="w">
   </span><span class="nv">$publicIP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Get-AzPublicIpAddress</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$publicIPId</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nv">$publicIPId</span><span class="o">.</span><span class="nf">LastIndexOf</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> 
   </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$publicIP</span><span class="p">)</span><span class="w">
   </span><span class="p">{</span><span class="w">      
      </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$publicIP</span><span class="o">.</span><span class="nf">Sku</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Basic'</span><span class="p">)</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nv">$netInterface</span><span class="o">.</span><span class="nf">IpConfigurations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">PublicIpAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$null</span><span class="w">
         </span><span class="nf">Set-AzNetworkInterface</span><span class="w"> </span><span class="nt">-NetworkInterface</span><span class="w"> </span><span class="nv">$netInterface</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$nic</span><span class="o">.</span><span class="nf">Primary</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"True"</span><span class="p">)</span><span class="w">
   </span><span class="p">{</span><span class="w">
      </span><span class="nf">Add-AzVMNetworkInterface</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nv">$newVM</span><span class="w"> </span><span class="nt">-Id</span><span class="w"> </span><span class="nv">$nic</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Primary</span><span class="w">
   </span><span class="p">}</span><span class="w">
   </span><span class="kr">else</span><span class="w">
   </span><span class="p">{</span><span class="w">
      </span><span class="nf">Add-AzVMNetworkInterface</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nv">$newVM</span><span class="w"> </span><span class="nt">-Id</span><span class="w"> </span><span class="nv">$nic</span><span class="o">.</span><span class="nf">Id</span><span class="w"> 
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Recreate the VM</span><span class="w">
</span><span class="nf">New-AzVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$originalVM</span><span class="o">.</span><span class="nf">Location</span><span class="w"> </span><span class="nt">-VM</span><span class="w"> </span><span class="nv">$newVM</span><span class="w"> </span><span class="nt">-DisableBginfoExtension</span><span class="w">

</span><span class="c"># If the machine is SQL server, create a new SQL Server object</span><span class="w">
</span><span class="nf">New-AzSqlVM</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$resourceGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$newVM</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-Location</span><span class="w"> </span><span class="nv">$location</span><span class="w"> </span><span class="nt">-LicenseType</span><span class="w"> </span><span class="nx">PAYG</span><span class="w"> 

</span></pre></table></code></div></div></div><div class="post-tail text-muted"><div class="mb-4"> <a href="/tags/vms/" class="post-tag no-text-decoration" >VMs</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >PowerShell</a> <a href="/tags/availability-zones/" class="post-tag no-text-decoration" >Availability Zones</a></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 topbar-down"><div class="access"><div id="access-lastmod" class="post mb-4"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/curl-appgateway-error/">SSL certificate error when accessing Application Gateway listener using curl</a></li><li><a href="/posts/appconfig-secrets-from-net-console-application/">How to use Key Vault references in App Configuration from .NET Framework Console application</a></li><li><a href="/posts/apim-basic-auth-keyvault/">Basic authentication in API Management using Key Vault</a></li><li><a href="/posts/migrate-virtual-machine-into-availability-zone/">Migrate virtual machine into availability zone</a></li><li><a href="/posts/generate-self-signed-certificates/">Generate self signed certificates</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/certificates/">Certificates</a> <a class="post-tag" href="/tags/application-gateway/">Application Gateway</a> <a class="post-tag" href="/tags/apimpolicy/">APIMPolicy</a> <a class="post-tag" href="/tags/vms/">VMs</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/keyvault/">KeyVault</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/bash/">Bash</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="javascript:;" class="btn btn-outline-primary disabled"><p>-</p></a> <a href="/posts/generate-self-signed-certificates/" class="btn btn-outline-primary"><p>Generate self signed certificates</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const observer = lozad(); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="copyright"><p class="mb-0"> © 2020<a href="https://www.linkedin.com/in/aleksandarstefanov" class="ml-1">Aleksandar Stefanov</a>. <br>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener noreferrer">Jekyll</a> with theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a>.</p></div><div class="license"><p class="mb-0"> The blog posts on this site are licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/certificates/">Certificates</a> <a class="post-tag" href="/tags/application-gateway/">Application Gateway</a> <a class="post-tag" href="/tags/apimpolicy/">APIMPolicy</a> <a class="post-tag" href="/tags/vms/">VMs</a> <a class="post-tag" href="/tags/powershell/">Powershell</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/keyvault/">KeyVault</a> <a class="post-tag" href="/tags/jekyll/">Jekyll</a> <a class="post-tag" href="/tags/bash/">Bash</a> <a class="post-tag" href="/tags/azure-devops/">Azure DevOps</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-158589035-1', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://tosokr.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
